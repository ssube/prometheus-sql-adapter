# Prometheus SQL Adapter

Inspired by the [Timescale PostgreSQL adapter](https://github.com/timescale/prometheus-postgresql-adapter) but
compatible with Aurora PostgreSQL, Azure Database for PostgreSQL, and other managed PostgreSQL services.

- keeps a compatible schema with labels in JSONB
- uses Go's SQL package
- uses bulk copy
- does not require `pg_prometheus` extension
- does not use printf to build SQL queries

## Schema

This adapter uses a schema that is compatible with [the Timescale `pg_prometheus` adapter](https://github.com/timescale/prometheus-postgresql-adapter/) but does not require the `pg_prometheus` extension or `SUPERUSER`/plugin permissions.

With v0.2, the metric labels and samples are separated into two data tables and a joining view, linked by a label ID
(`lid`). The `lid` is generated by calling the Prometheus metric's `String()` method, then taking the base64-encoded
SHA-1 hash of the results. This provides a short, deterministic identifier for each unique set of labels at the cost
of some CPU (less than `100m` per 1k samples/sec on an old Xeon E3-1245v2).

The resulting schema can be `\d`escribed as:

```sql
\d+ metric_labels
                                         Table "public.metric_labels"
 Column |            Type             | Collation | Nullable | Default | Storage  | Stats target | Description 
--------+-----------------------------+-----------+----------+---------+----------+--------------+-------------
 lid    | text                        |           | not null |         | extended |              | 
 time   | timestamp without time zone |           | not null |         | plain    |              | 
 labels | jsonb                       |           |          |         | extended |              | 
Indexes:
    "metric_labels_lid" UNIQUE, btree (lid)
    "metric_labels_labels" gin (labels)

\d+ metric_samples
                                         Table "public.metric_samples"
 Column |            Type             | Collation | Nullable | Default | Storage  | Stats target | Description 
--------+-----------------------------+-----------+----------+---------+----------+--------------+-------------
 time   | timestamp without time zone |           | not null |         | plain    |              | 
 name   | text                        |           | not null |         | extended |              | 
 lid    | text                        |           | not null |         | extended |              | 
 value  | double precision            |           |          |         | plain    |              | 
Indexes:
    "metric_samples_name_time_idx" btree (name, "time" DESC)
    "metric_samples_time_idx" btree ("time" DESC)

\d+ metrics
                                     View "public.metrics"
 Column |            Type             | Collation | Nullable | Default | Storage  | Description 
--------+-----------------------------+-----------+----------+---------+----------+-------------
 time   | timestamp without time zone |           |          |         | plain    | 
 name   | text                        |           |          |         | extended | 
 lid    | text                        |           |          |         | extended | 
 value  | double precision            |           |          |         | plain    | 
 labels | jsonb                       |           |          |         | extended | 
View definition:
 SELECT s."time",
    s.name,
    s.lid,
    s.value,
    l.labels
   FROM metric_samples s
     JOIN metric_labels l ON s.lid = l.lid;
```
